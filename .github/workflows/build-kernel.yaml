name: Workflow A - Build Samsung OSS kernel 6.6 using GKI prebuilts/externals (symlink overlay)

on:
  workflow_dispatch:
    inputs:
      gki_manifest_branch:
        description: "GKI manifest branch"
        required: true
        default: "common-android15-6.6-lts"
      samsung_kernel_repo:
        description: "Samsung OSS kernel repo URL"
        required: true
        default: "https://github.com/SavedByLight-WIP/android_kernel_samsung_a14m_mt6768.git"
      samsung_kernel_ref:
        description: "Samsung OSS kernel ref (branch/tag/sha)"
        required: true
        default: "master"
      project:
        description: "Samsung build PROJECT"
        required: true
        default: "a14m"
      mode:
        description: "Samsung build MODE"
        required: true
        default: "user"

jobs:
  build-samsung:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Checkout workflow repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Install host dependencies
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y \
            git curl ca-certificates \
            python3 python3-venv python3-pip \
            bc bison flex build-essential \
            libssl-dev libelf-dev \
            rsync xz-utils zstd unzip jq file

          # Android "repo" tool
          sudo curl -fsSL https://storage.googleapis.com/git-repo-downloads/repo -o /usr/local/bin/repo
          sudo chmod +x /usr/local/bin/repo
          repo --version

      # -------------------------------
      # 1) Fetch GKI tree (provider of prebuilts + externals)
      # Cache ONLY .repo (repo-sync cache only)
      # -------------------------------
      - name: Prepare GKI workspace
        run: |
          set -euo pipefail
          mkdir -p gki

      - name: Restore GKI .repo cache
        id: cache-gki-repo
        uses: actions/cache@v4
        with:
          path: gki/.repo
          key: repo-gki-${{ runner.os }}-${{ inputs.gki_manifest_branch }}
          restore-keys: |
            repo-gki-${{ runner.os }}-${{ inputs.gki_manifest_branch }}-
            repo-gki-${{ runner.os }}-

      - name: Debug - Cache status (GKI .repo)
        run: |
          set -euo pipefail
          echo "cache-hit(gki/.repo)=${{ steps.cache-gki-repo.outputs.cache-hit }}"
          if [[ -d gki/.repo ]]; then
            du -sh gki/.repo || true
            du -sh gki/.repo/manifests gki/.repo/manifests.git 2>/dev/null || true
            du -sh gki/.repo/projects gki/.repo/project-objects 2>/dev/null || true
          fi

      - name: repo init (GKI lts, shallow)
        working-directory: gki
        run: |
          set -euo pipefail
          repo init -u https://android.googlesource.com/kernel/manifest \
            -b "${{ inputs.gki_manifest_branch }}" \
            --depth=1

      - name: repo sync (GKI, incremental shallow)
        working-directory: gki
        run: |
          set -euo pipefail
          [[ -d .repo/manifests ]] || { echo "ERROR: gki/.repo/manifests missing after repo init"; exit 1; }
          echo "Repo sync (GKI) startingâ€¦ cache-hit=${{ steps.cache-gki-repo.outputs.cache-hit }}"
          repo sync -c -j"$(nproc)" --no-tags
          echo "Repo sync (GKI) done."

      # -------------------------------
      # 2) Clone Samsung OSS repo
      # -------------------------------
      - name: Clone Samsung OSS kernel repo
        run: |
          set -euo pipefail
          git clone --depth 1 --branch "${{ inputs.samsung_kernel_ref }}" \
            "${{ inputs.samsung_kernel_repo }}" samsung

      # -------------------------------
      # 3) Assemble Samsung workspace by symlinking from GKI
      #    - Provide repo-root external/* to satisfy kernel/external/* symlinks
      #    - Provide kernel/prebuilts by symlink to GKI kernel/prebuilts
      # -------------------------------
      - name: Overlay (symlink) externals + prebuilts from GKI into Samsung workspace
        run: |
          set -euo pipefail

          GKI_ROOT="$PWD/gki"
          SAMSUNG_ROOT="$PWD/samsung"

          echo "GKI_ROOT=$GKI_ROOT"
          echo "SAMSUNG_ROOT=$SAMSUNG_ROOT"

          # 3a) Ensure Samsung repo-root external exists
          mkdir -p "$SAMSUNG_ROOT/external"

          # Samsung has kernel/external/* -> ../../external/*.
          # Populate Samsung repo-root external/* with symlinks to GKI external/*.
          if [[ ! -d "$GKI_ROOT/external" ]]; then
            echo "ERROR: GKI external/ directory missing. Cannot satisfy Samsung kernel/external symlinks."
            exit 1
          fi

          echo "Linking externals from GKI -> Samsung repo-root external/ ..."
          for d in "$GKI_ROOT"/external/*; do
            [[ -d "$d" ]] || continue
            name="$(basename "$d")"
            # If Samsung already has something, leave it (but warn).
            if [[ -e "$SAMSUNG_ROOT/external/$name" ]]; then
              echo "WARN: samsung/external/$name already exists; leaving as-is"
            else
              ln -s "$d" "$SAMSUNG_ROOT/external/$name"
            fi
          done

          # 3b) Provide Samsung kernel/prebuilts via symlink
          if [[ ! -d "$GKI_ROOT/kernel/prebuilts" ]]; then
            echo "ERROR: GKI kernel/prebuilts missing."
            exit 1
          fi

          mkdir -p "$SAMSUNG_ROOT/kernel"
          if [[ -e "$SAMSUNG_ROOT/kernel/prebuilts" ]]; then
            echo "WARN: samsung/kernel/prebuilts already exists; leaving as-is"
          else
            ln -s "$GKI_ROOT/kernel/prebuilts" "$SAMSUNG_ROOT/kernel/prebuilts"
          fi

      # -------------------------------
      # 4) Guardrails: fail fast with clear messages
      # -------------------------------
      - name: Guardrails - verify Samsung workspace expectations
        run: |
          set -euo pipefail
          SAMSUNG_ROOT="$PWD/samsung"

          echo "=== Verify Samsung kernel/external symlinks resolve ==="
          # Example external - ensure target exists
          if [[ -L "$SAMSUNG_ROOT/kernel/external/bazel-skylib" ]]; then
            tgt="$(readlink "$SAMSUNG_ROOT/kernel/external/bazel-skylib")"
            echo "kernel/external/bazel-skylib -> $tgt"
          else
            echo "WARN: samsung/kernel/external/bazel-skylib is not a symlink (unexpected per your report)"
          fi
          [[ -d "$SAMSUNG_ROOT/external/bazel-skylib" ]] || { echo "ERROR: samsung/external/bazel-skylib missing"; exit 1; }

          echo "=== Verify prebuilts paths Samsung build hardcodes ==="
          [[ -x "$SAMSUNG_ROOT/kernel/prebuilts/build-tools/path/linux-x86/python3" ]] || { echo "ERROR: missing python3 at kernel/prebuilts/build-tools/path/linux-x86/python3"; exit 1; }
          [[ -x "$SAMSUNG_ROOT/kernel/prebuilts/kernel-build-tools/bazel/linux-x86_64/bazel" ]] || { echo "ERROR: missing bazel at kernel/prebuilts/kernel-build-tools/bazel/linux-x86_64/bazel"; exit 1; }
          [[ -d "$SAMSUNG_ROOT/kernel/prebuilts/jdk" ]] || { echo "ERROR: missing kernel/prebuilts/jdk"; exit 1; }

          echo "=== Verify vendor local repositories exist (WORKSPACE new_local_repository paths) ==="
          [[ -d "$SAMSUNG_ROOT/vendor/mediatek" ]] || { echo "ERROR: missing vendor/mediatek"; exit 1; }
          [[ -d "$SAMSUNG_ROOT/vendor/mediatek/kernel_modules" ]] || { echo "ERROR: missing vendor/mediatek/kernel_modules"; exit 1; }

          echo "Guardrails OK."

      # -------------------------------
      # 5) Build Samsung kernel
      # -------------------------------
      - name: Build Samsung kernel (kernel_device_modules-6.6/build.sh)
        env:
          PROJECT: ${{ inputs.project }}
          MODE: ${{ inputs.mode }}
        run: |
          set -euo pipefail
          cd samsung/kernel
          ./kernel_device_modules-6.6/build.sh

      - name: Upload Samsung dist artifacts
        uses: actions/upload-artifact@v4
        with:
          name: samsung-${{ inputs.project }}-${{ inputs.mode }}-dist
          path: |
            samsung/kernel/out/**/dist/**
          if-no-files-found: error

      - name: Debug - Workspace listing (Samsung, depth<=3)
        if: always()
        working-directory: samsung
        run: |
          set -euo pipefail
          echo "=== Samsung workspace directories (depth<=3) ==="
          find . -maxdepth 3 -type d -print | sed -n '1,300p'
          echo "=== Samsung workspace files (depth<=3, first 300) ==="
          find . -maxdepth 3 -type f -print | sed -n '1,300p'
